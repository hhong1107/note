



### 参考网站

[利用K8S技术栈打造个人私有云（连载之：K8S集群搭建）](https://yq.aliyun.com/articles/419570?spm=5176.10695662.1996646101.searchclickresult.715942e48ZzaXa)

-[Kubernetes核心概念总结](http://www.cnblogs.com/zhenyuyaodidiao/p/6500720.html)

-[第一章 kubernetes入门](https://www.jianshu.com/p/63ffc2214788)

[你女儿也能看懂的插画版Kubernetes指南](http://www.linuxidc.com/Linux/2016-07/132908.htm)

-[十分钟带你理解Kubernetes核心概念](http://www.dockone.io/article/932)

[Kubernetes和Spring Cloud哪个部署微服务更好](http://blog.csdn.net/qq_34463875/article/details/53816943)

[搭建及使用K8s集群  <目录> ](http://blog.csdn.net/justhavetry/article/details/78248436)

[搭建及使用K8s集群 <k8s 集群部署springcloud 多应用>](http://blog.csdn.net/justhavetry/article/details/78249590)

[搭建及使用K8s集群 <k8s集群部署springcloud 单应用>](http://blog.csdn.net/justhavetry/article/details/78247429)

[搭建及使用K8s集群 <使用ingress 暴露springcloud服务>](http://blog.csdn.net/justhavetry/article/details/78257374)

[JustHaveTry的专栏](http://blog.csdn.net/justhavetry)

-[使用kubernetes访问外部服务（mysql\redis）](http://blog.csdn.net/qq_35904833/article/details/77447867)

-[理解Kubernetes网络之Flannel网络](http://tonybai.com/2017/01/17/understanding-flannel-network-for-kubernetes/)

-[Kubernetes的网络模型](http://blog.csdn.net/zjysource/article/details/52052420)

-[kubenetes学习3--Namespace命名空间](http://blog.csdn.net/dream_broken/article/details/53128595)

-[ kubernetes资源对象--deployment](http://blog.csdn.net/liyingke112/article/details/76546630)  ※

-[知乎讨论](https://www.zhihu.com/topic/20018384/top-answers)

-[kubernetes中文社区](https://www.kubernetes.org.cn/doc-4)

-[《Kubernetes权威指南》——入门](http://www.cnblogs.com/suolu/p/6734528.html)

-[kubernetes github地址](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.9.md#server-binaries-1)

-[Kubernetes kubectl 命令表](http://docs.kubernetes.org.cn/683.html)

-[Kubectl 客户端的下载和配置](http://blog.csdn.net/csdn_duomaomao/article/details/76159874)

-[使用 kubeadm 创建 kubernetes 1.9 集群](https://www.kubernetes.org.cn/3357.html)

-[一个适合 Kubernetes 的最佳网络互联方案](http://www.dockone.io/article/1115)

-[Kubernetes 1.2 新功能介绍：Ingress 原理及实例](http://blog.csdn.net/liukuan73/article/details/54861763)

-[了解Kubernetes部署功能](http://blog.csdn.net/s1234567_89/article/details/53783558)

-[Kubernetes实战（一）](http://blog.csdn.net/wyd987100/article/details/51680693)

-[Kubernetes DNS部署](http://blog.csdn.net/carter115/article/details/51133688) ※

-[Kubernetes 1.2 新功能介绍：Deployment](http://blog.csdn.net/liukuan73/article/details/54710766?utm_source=itdadao&utm_medium=referral)

-[使用YAML创建一个 Kubernetes Depolyment](https://www.kubernetes.org.cn/1414.html)  有部分关于yaml语法的介绍

-[Kubernetes部分Volume类型介绍及yaml示例](http://www.cnblogs.com/zhenyuyaodidiao/p/6594541.html) ※

-[Kubernetes |Pod 深入理解与实践](https://www.jianshu.com/p/d867539a15cf)

-[ kubernetes创建资源对象yaml文件例子--pod](http://blog.csdn.net/liyingke112/article/details/76155428) ※

-[kubernetes将外部服务映射为内部服务](http://blog.csdn.net/liyingke112/article/details/76204038) ※

-[kubernetes yaml 文件注释](http://blog.csdn.net/xuleisdjn/article/details/79023487)

-[ kubernetes创建资源对象yaml文件例子--rc](http://blog.csdn.net/liyingke112/article/details/76526000)

-[聊聊你可能误解的Kubernetes Deployment滚动更新机制](http://blog.csdn.net/WaltonWang/article/details/77461697?locationNum=5&fps=1)

-[Kubernetes系列05：深入掌握Service](http://blog.csdn.net/levy_cui/article/details/70336283) ※
-[kubernetes 服务发现与注册个人想法](http://blog.csdn.net/qq_29778131/article/details/73603494)
-[kubeadm 搭建 Kubernetes 集群](https://www.kubernetes.org.cn/878.html)
-[离线使用 kubeadm 创建 kubernetes 1.9.2 集群](https://my.oschina.net/binges/blog/1615955)
-[kubernetes1.9离线部署](http://blog.51cto.com/cstsncv/2061943)
-[在生产环境使用Kuberntes一年后，我们总结了这些经验和教训](https://www.jianshu.com/p/f0b980e9fa25)
-[官方文档](https://kubernetes.io/docs/concepts/)

-[使用kubeadm在Ubuntu16.04上搭建Kubernetes1.5集群](https://www.jianshu.com/p/602c5bdbbd4d)
-[NETFLIX OSS, SPRING CLOUD 以及 KUBERNETES？关于它们的种种！](http://www.useopen.net/blog/2016/netflix-oss-or-kubernetes-how-about-both.html)
-[Kubernetes入门（三） - 网络](http://blog.csdn.net/ztsinghua/article/details/52411440)


-[Netflix OSS、Spring Cloud还是Kubernetes? 都要吧！](http://www.infoq.com/cn/articles/netflix-oss-spring-cloud-kubernetes?utm_source=infoq&utm_medium=popular_widget&utm_campaign=popular_content_list&utm_content=presentation)

-[关于Kubernetes在2018年发展趋势的4项预测](https://www.kubernetes.org.cn/3516.html)

-[说说Kubernetes是怎么来的，又是怎么没的](https://www.kubernetes.org.cn/3518.html) ※

-[是时候使用Helm了：Helm, Kubernetes的包管理工具](https://www.kubernetes.org.cn/3435.html)

-[Kubernretes免费视频课程 | 开放技术*IBM微讲堂出品](https://www.kubernetes.org.cn/3546.html)

-[Kubernretes免费视频课程 | 开放技术*IBM微讲堂出品](https://www.kubernetes.org.cn/3546.html)

-[Kubernretes免费视频课程 | 开放技术*IBM微讲堂出品](https://www.kubernetes.org.cn/3546.html)

- [gitlab上的kubernetes设配springcloud](https://github.com/fabric8io/spring-cloud-kubernetes) gitlab上的kubernetes设配springcloud
  [中文社区](https://www.kubernetes.org.cn/)

-[Kubernetes之kubectl常用命令使用指南:2:故障排查](https://blog.csdn.net/liumiaocn/article/details/73925301)
-[Kubernetes中Service机制](https://www.jianshu.com/p/bbb673e79c3e)
-[如何在Kubernetes中暴露服务访问](https://segmentfault.com/a/1190000007990723)

----

-[centos7下安装kubectl](http://www.niuhp.com/docker/install-kubectl-on-centos7-64.html)  参考这个网站下载zip包来安装

-[Kubernetes网络原理及方案](https://www.kubernetes.org.cn/2059.html)

-


### 命令

````shell
	minikube start
	minikube stop
    minikube status
    minikube dashboard
    kubectl cluster-info  - 查看状态
    kubectl get deploy xxx

    kubectl get po -o wide
    kubectl get rs
    # 查看service
    kubectl get svc

    # 查看暴露的端口
    kubectl get ep
    
    kubectl logs xxx
    kubectl exec -it  xxx /bin/bash

    # 升级image
    kubectl set image deploy nginx nginx=nginx:1.9.1
    # 查看详细详细
    kubectl describe deploy nginx
    # 使用kubectl apply -f 选择新版本的文件，k8s会自动对比运行中版本、老版本、新版本之间的区别，自动更新应用
    kubectl apply -f nginx-app-v2.yaml
````



sudo swapoff -a

https://storage.googleapis.com/kubernetes-release/release/v1.9.3/bin/linux/amd64/kubectl


http://www.niuhp.com/docker/install-kubectl-on-centos7-64.html  使用这个安装

http://blog.csdn.net/qq_35904833/article/details/77447867  连接数据库





-----



### 集群搭建



####  参考网站

-[资源下载](https://pan.baidu.com/s/1eUixGvo) 已经保存在百度云盘的 软件里面了

-[liu9718214的专栏](http://blog.csdn.net/liu9718214)



-[Kubernetes HA 1.9 高可用集群,本地离线部署](https://mp.weixin.qq.com/s?__biz=MzI5ODQ2MzI3NQ==&mid=2247484401&idx=1&sn=514ca7654d686a7938b6b1f821a61139&chksm=eca43ab5dbd3b3a3e0390708e4d5cc7ed5e0651038e05b704ae341d625f4eb273d4e55ed9489&scene=38#wechat_redirect) 微信上的 还不错

> 
>
> - k8s 高可用2个核心 ==apiserver master== and ==etcd==
> - ==apiserver master==：（需高可用）集群核心，集群API接口、集群各个组件通信的中枢；集群安全控制；
> - ==etcd== ：（需高可用）集群的数据中心，用于存放集群的配置以及状态信息，非常重要，如果数据丢失那么集群将无法恢复；因此高可用集群部署首先就是etcd是高可用集群；
> - kube-scheduler：调度器 （内部自选举）集群Pod的调度中心；默认kubeadm安装情况下–leader-elect参数已经设置为true，保证master集群中只有一个kube-scheduler处于活跃状态；
> - kube-controller-manager： 控制器 （内部自选举）集群状态管理器，当集群状态与期望不同时，kcm会努力让集群恢复期望状态，比如：当一个pod死掉，kcm会努力新建一个pod来恢复对应replicas set期望的状态；默认kubeadm安装情况下–leader-elect参数已经设置为true，保证master集群中只有一个kube-controller-manager处于活跃状态；
> - kubelet: agent node注册apiserver
> - kube-proxy: 每个node上一个，负责service vip到endpoint pod的流量转发，老版本主要通过设置iptables规则实现，新版1.9基于kube-proxy-lvs 实现



-[Kubernetes 1.9集群使用traefik发布服务](http://blog.51cto.com/ylw6006/2073718)

-[kubernetes1.9离线部署](http://blog.csdn.net/liu9718214/article/details/79242849)  ☆☆☆☆☆ 重点参考

-[Kubernetes之kubectl常用命令](http://blog.csdn.net/xingwangc2014/article/details/51204224)☆☆☆

-[安装k8s 1.9.0 实践：问题集锦](https://blog.csdn.net/zhd930818/article/details/79644903) ☆☆☆

````shell
# 有节点一直连接不上去报：Error adding network: failed to set bridge addr: "cni0" already has an IP address different from
# 需要清理环境
kubeadm reset
rm -rf /var/lib/cni/flannel/* && rm -rf /var/lib/cni/networks/cbr0/* && ip link delete cni0  
rm -rf /var/lib/cni/networks/cni0/*

# 如果执行命令的时候报参数过长
find . -name "*" -print | xargs rm -rf 
````



-[使用kubeadm安装kubernetes1.7/1.8/1.9](http://blog.csdn.net/zhuchuangang/article/details/76572157)  这个用的是阿里云的

-[一键安装脚本](https://github.com/zhuchuangang/k8s-install-scripts/tree/master/kubeadm)

-[Kubernetes环境下的各种调试方法](http://www.cnblogs.com/Jack47/p/debugging-kubernetes-pod.html)

-[kubernetes RBAC实战 kubernetes 用户角色访问控制，dashboard访问，kubectl配置生成](http://www.zhimengzhe.com/bianchengjiaocheng/qitabiancheng/388943.html)
-[解决Kubernetes 1.6.4 Dashboard无法访问的问题](https://tonybai.com/2017/07/20/fix-cannot-access-dashboard-in-k8s-1-6-4/)
````
- --authentication-mode=basic
使用账户密码登录
````

-[Kubernetes Dashboard 1.7.0部署二三事](https://tonybai.com/2017/09/26/some-notes-about-deploying-kubernetes-dashboard-1-7-0/)

-[ Kubernetes dashboard1.8.0 WebUI安装与配置](http://blog.csdn.net/A632189007/article/details/78840971)

-[Dashboard - Kubernetes的全功能Web界面](https://segmentfault.com/a/1190000006223166)

````
kubectl logs <pod_name>


````

[kubernetes集群问题排查](http://blog.csdn.net/huwh_/article/details/71308301)

-[和我一步步部署 kubernetes 集群](https://github.com/opsnull/follow-me-install-kubernetes-cluster)

-[kubeadm-highavailiability - 基于kubeadm的kubernetes高可用集群部署，支持v1.9.x和v1.7.x版本以及v1.6.x版本](https://github.com/cookeem/kubeadm-ha/blob/master/README_CN.md)



-[Kubernetes系统常见运维技巧](http://blog.csdn.net/horsefoot/article/details/51594840)

-[Kubernetes常用命令与常见问题](http://blog.csdn.net/bluishglc/article/details/52440312)

-[使用Kubeadm安装Kubernetes1.5版本](https://www.kubernetes.org.cn/1165.html)

-[使用kubeadm部署kubernetes](http://blog.csdn.net/Andriy_dangli/article/details/79269348)

-[Kubernetes初探：原理及实践应用](https://www.aliyun.com/zixun/content/2_6_1883652.html)

-[安装部署 Kubernetes 集群](http://www.cnblogs.com/Leo_wl/p/8511902.html) 管理台回头可以看一下

#### 命令

````shell
# 删除节点
kubectl delete node 节点名字
````



#### [kubernetes-dashboard安装](https://www.cnblogs.com/netsa/p/8376526.html)



````shell
docker pull registry.docker-cn.com/kubernetesdashboarddev/kubernetes-dashboard-amd64:head

````

- 文件一:dashboard.yaml：

````yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubernetes-dashboard
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: kubernetes-dashboard
  labels:
    k8s-app: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: kubernetes-dashboard
  namespace: kube-system
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: kubernetes-dashboard
  namespace: kube-system
  labels:
    k8s-app: kubernetes-dashboard
    kubernetes.io/cluster-service: "true"
    addonmanager.kubernetes.io/mode: Reconcile
spec:
  selector:
    matchLabels:
      k8s-app: kubernetes-dashboard
  template:
    metadata:
      labels:
        k8s-app: kubernetes-dashboard
      annotations:
        scheduler.alpha.kubernetes.io/critical-pod: ''
    spec:
      serviceAccountName: kubernetes-dashboard
      containers:
      - name: kubernetes-dashboard
        image: registry.docker-cn.com/kubernetesdashboarddev/kubernetes-dashboard-amd64:head
        resources:
          limits:
            cpu: 100m
            memory: 300Mi
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 9090
        livenessProbe:
          httpGet:
            path: /
            port: 9090
          initialDelaySeconds: 30
          timeoutSeconds: 30
      tolerations:
      - key: "CriticalAddonsOnly"
        operator: "Exists"
````



- 文件二：dashboard-svc.yaml文件

````yaml
apiVersion: v1
kind: Service
metadata:
  name: kubernetes-dashboard
  namespace: kube-system
  labels:
    k8s-app: kubernetes-dashboard
    kubernetes.io/cluster-service: "true"
    addonmanager.kubernetes.io/mode: Reconcile
spec:
  selector:
    k8s-app: kubernetes-dashboard
  type: NodePort
  ports:
  - port: 9090
    targetPort: 9090
    nodePort: 32017
````

- 部署：

````shell
kubectl create -f dashboard.yaml
kubectl create -f dashboard-svc.yaml
````

- 访问：32017端口 就是前面配置的咯


#### Kubernetes监控(Heapster)

参考网站：https://www.jianshu.com/p/3f803cd02d74

````shell
# 运行 yaml 文件
kubectl create -f http://res.yinnote.com/kubernetes/heapster/1.5.1/heapster-rbac.yaml
kubectl create -f http://res.yinnote.com/kubernetes/heapster/1.5.1/influxdb/heapster.yaml

# 安装 InfluxDB
kubectl create -f http://res.yinnote.com/kubernetes/heapster/1.5.1/influxdb/influxdb.yaml

# 安装Grafana
kubectl create -f http://res.yinnote.com/kubernetes/heapster/1.5.1/influxdb/grafana.yaml

# 最后访问 31235

````



#### yaml示例



##### pod yaml

````yaml

apiVersion: v1 #指定api版本，此值必须在kubectl apiversion中  
kind: Pod #指定创建资源的角色/类型  
metadata: #资源的元数据/属性  
  name: web04-pod #资源的名字，在同一个namespace中必须唯一  
  labels: #设定资源的标签，详情请见http://blog.csdn.net/liyingke112/article/details/77482384
    k8s-app: apache  
    version: v1  
    kubernetes.io/cluster-service: "true"  
  annotations:            #自定义注解列表  
    - name: String        #自定义注解名字  
spec:#specification of the resource content 指定该资源的内容  
  restartPolicy: Always #表明该容器一直运行，默认k8s的策略，在此容器退出后，会立即创建一个相同的容器  
  nodeSelector:     #节点选择，先给主机打标签kubectl label nodes kube-node1 zone=node1  
    zone: node1  
  containers:  
  - name: web04-pod #容器的名字  
    image: web:apache #容器使用的镜像地址  
    imagePullPolicy: Never #三个选择Always、Never、IfNotPresent，每次启动时检查和更新（从registery）images的策略，
                           # Always，每次都检查
                           # Never，每次都不检查（不管本地是否有）
                           # IfNotPresent，如果本地有就不检查，如果没有就拉取
    command: ['sh'] #启动容器的运行命令，将覆盖容器中的Entrypoint,对应Dockefile中的ENTRYPOINT  
    args: ["$(str)"] #启动容器的命令参数，对应Dockerfile中CMD参数  
    env: #指定容器中的环境变量  
    - name: str #变量的名字  
      value: "/etc/run.sh" #变量的值  
    resources: #资源管理，请求请见http://blog.csdn.net/liyingke112/article/details/77452630
      requests: #容器运行时，最低资源需求，也就是说最少需要多少资源容器才能正常运行  
        cpu: 0.1 #CPU资源（核数），两种方式，浮点数或者是整数+m，0.1=100m，最少值为0.001核（1m）
        memory: 32Mi #内存使用量  
      limits: #资源限制  
        cpu: 0.5  
        memory: 32Mi  
    ports:  
    - containerPort: 80 #容器开发对外的端口
      name: httpd  #名称
      protocol: TCP  
    livenessProbe: #pod内容器健康检查的设置，详情请见http://blog.csdn.net/liyingke112/article/details/77531584
      httpGet: #通过httpget检查健康，返回200-399之间，则认为容器正常  
        path: / #URI地址  
        port: 80  
        #host: 127.0.0.1 #主机地址  
        scheme: HTTP  
      initialDelaySeconds: 180 #表明第一次检测在容器启动后多长时间后开始  
      timeoutSeconds: 5 #检测的超时时间  
      periodSeconds: 15  #检查间隔时间  
      #也可以用这种方法  
      #exec: 执行命令的方法进行监测，如果其退出码不为0，则认为容器正常  
      #  command:  
      #    - cat  
      #    - /tmp/health  
      #也可以用这种方法  
      #tcpSocket: //通过tcpSocket检查健康   
      #  port: number   
    lifecycle: #生命周期管理  
      postStart: #容器运行之前运行的任务  
        exec:  
          command:  
            - 'sh'  
            - 'yum upgrade -y'  
      preStop:#容器关闭之前运行的任务  
        exec:  
          command: ['service httpd stop']  
    volumeMounts:  #详情请见http://blog.csdn.net/liyingke112/article/details/76577520
    - name: volume #挂载设备的名字，与volumes[*].name 需要对应    
      mountPath: /data #挂载到容器的某个路径下  
      readOnly: True  
  volumes: #定义一组挂载设备  
  - name: volume #定义一个挂载设备的名字  
    #meptyDir: {}  
    hostPath:  
      path: /opt #挂载设备类型为hostPath，路径为宿主机下的/opt,这里设备类型支持很多种  
````







### 日志

#### dns无法启动



````shell
systemctl stop kubelet
systemctl stop docker.service
systemctl start docker.service
systemctl restart docker.service
systemctl status docker.service
systemctl start  docker 
systemctl daemon-reload
systemctl start  kubelet
````

> 注意看/var/log/message 的日志
>
> 里面显示了无法删除文件
>
> 然后看了下有一些dead的容器
>
> 参考下面的找到这些文件的进程把他kill掉有dead的容器就自动消失了 k8s就可以自动部署了
>
> > Jun 25 17:08:31 k8s-master dockerd: time="2018-06-25T17:08:31.846844481+08:00" level=error msg="Error removing mounted layer d670175bf0854928fac55d97d1590a16209c3005a8005731a560155b7c8f916f: remove /var/lib/docker/overlay/d45dacde14e716217e8a52dc7b9500f3d1addff09a4b035a4974af660f7ccc52/merged: device or resource busy"
> > Jun 25 17:08:31 k8s-master dockerd: time="2018-06-25T17:08:31.846951090+08:00" level=error msg="Handler for DELETE /v1.30/containers/d670175bf0854928fac55d97d1590a16209c3005a8005731a560155b7c8f916f returned error: driver \"overlay\" failed to remove root filesystem for d670175bf0854928fac55d97d1590a16209c3005a8005731a560155b7c8f916f: remove /var/lib/docker/overlay/d45dacde14e716217e8a52dc7b9500f3d1addff09a4b035a4974af660f7ccc52/merged: device or resource busy"
> > Jun 25 17:08:31 k8s-master kubelet: E0625 17:08:31.847421   16139 remote_runtime.go:246] RemoveContainer "d670175bf0854928fac55d97d1590a16209c3005a8005731a560155b7c8f916f" from runtime service failed: rpc error: code = Unknown desc = failed to remove container "d670175bf0854928fac55d97d1590a16209c3005a8005731a560155b7c8f916f": Error response from daemon: driver "overlay" failed to remove root filesystem for d670175bf0854928fac55d97d1590a16209c3005a8005731a560155b7c8f916f: remove /var/lib/docker/overlay/d45dacde14e716217e8a52dc7b9500f3d1addff09a4b035a4974af660f7ccc52/merged: device or resource busy
> > Jun 25 17:08:31 k8s-master kubelet: E0625 17:08:31.847513   16139 kuberuntime_gc.go:126] Failed to remove container "d670175bf0854928fac55d97d1590a16209c3005a8005731a560155b7c8f916f": rpc error: code = Unknown desc = failed to remove container "d670175bf0854928fac55d97d1590a16209c3005a8005731a560155b7c8f916f": Error response from daemon: driver "overlay" failed to remove root filesystem for d670175bf0854928fac55d97d1590a16209c3005a8005731a560155b7c8f916f: remove /var/lib/docker/overlay/d45dacde14e716217e8a52dc7b9500f3d1addff09a4b035a4974af660f7ccc52/merged: device or resource busy
> > Jun 25 17:08:32 k8s-master dockerd: time="2018-06-25T17:08:32.362603830+08:00" level=error msg="Error removing mounted layer 1a0e3db6ac7059243abecdd7a7848b1b667d3e6ab57859035c0c7850c4f9e74a: remove /var/lib/docker/overlay/1df383fb6d7ba842e5dd7fd8146e753766dce05fda4c04c3b1f6a288d79418b8/merged: device or resource busy"
> > Jun 25 17:08:32 k8s-master dockerd: time="2018-06-25T17:08:32.362698701+08:00" level=error msg="Handler for DELETE /v1.30/containers/1a0e3db6ac7059243abecdd7a7848b1b667d3e6ab57859035c0c7850c4f9e74a returned error: driver \"overlay\" failed to remove root filesystem for 1a0e3db6ac7059243abecdd7a7848b1b667d3e6ab57859035c0c7850c4f9e74a: remove /var/lib/docker/overlay/1df383fb6d7ba842e5dd7fd8146e753766dce05fda4c04c3b1f6a288d79418b8/merged: device or resource busy"
> > Jun 25 17:08:32 k8s-master kubelet: E0625 17:08:32.363132   16139 remote_runtime.go:246] RemoveContainer "1a0e3db6ac7059243abecdd7a7848b1b667d3e6ab57859035c0c7850c4f9e74a" from runtime service failed: rpc error: code = Unknown desc = failed to remove container "1a0e3db6ac7059243abecdd7a7848b1b667d3e6ab57859035c0c7850c4f9e74a": Error response from daemon: driver "overlay" failed to remove root filesystem for 1a0e3db6ac7059243abecdd7a7848b1b667d3e6ab57859035c0c7850c4f9e74a: remove /var/lib/docker/overlay/1df383fb6d7ba842e5dd7fd8146e753766dce05fda4c04c3b1f6a288d79418b8/merged: device or resource busy
> > Jun 25 17:08:32 k8s-master kubelet: E0625 17:08:32.363169   16139 kuberuntime_gc.go:126] Failed to remove container "1a0e3db6ac7059243abecdd7a7848b1b667d3e6ab57859035c0c7850c4f9e74a": rpc error: code = Unknown desc = failed to remove container "1a0e3db6ac7059243abecdd7a7848b1b667d3e6ab57859035c0c7850c4f9e74a": Error response from daemon: driver "overlay" failed to remove root filesystem for 1a0e3db6ac7059243abecdd7a7848b1b667d3e6ab57859035c0c7850c4f9e74a: remove /var/lib/docker/overlay/1df383fb6d7ba842e5dd7fd8146e753766dce05fda4c04c3b1f6a288d79418b8/merged: device or resource busy





> 
>
> [Docker删除DEAD状态的容器时报错](https://blog.csdn.net/xl_lx/article/details/78530908)
>
> 我使用的这个方法起作用了。
>
> I had the following error when removing a dead container (docker 17.06.1-ce on CentOS 7):
>
> ```
> Error response from daemon: driver "overlay" failed to remove root filesystem for <some-id>: 
>
> ```
>
> ```
> remove /var/lib/docker/overlay/<some-id>/merged: device or resource busy
>
> ```
>
> Here is how I fixed it:
>
> **1.** Check which other processes are also using docker resources
>
> $ grep docker /proc/*/mountinfo
>
> which outputs something like this, where the number after /proc/ is the pid:
>
> ```
> /proc/10001/mountinfo:179...
>
> ```
>
> ```
> /proc/10002/mountinfo:149...
>
> ```
>
> ```
> /proc/12345/mountinfo:159 149 0:36 / /var/lib/docker/overlay/...
>
> ```
>
> **2.** Check the process name of the above pid
>
> ```
> $ ps -p 10001 -o comm=
>
> ```
>
> ```
> dockerd
>
> ```
>
> ```
> $ ps -p 10002 -o comm=
>
> ```
>
> ```
> docker-containe
>
> ```
>
> ```
> $ ps -p 12345 -o comm=
>
> ```
>
> ```
> nginx   <<<-- This is suspicious!!!
>
> ```
>
> So, nginx with pid 12345 seems to also be using /var/lib/docker/overlay/..., which is why we cannot remove the related container and get the device or resource busy error. (See [here](https://github.com/moby/moby/issues/27381) for a discussion on how nginx shares the same mount namespace with docker containers thus prevents its deletion.)
>
> **3.** Stop nginx and then I can remove the container successfully.
>
> ```
> $ sudo service nginx stop
>
> $ docker rm <container-id>
>
> ```



#### 无法获取到dns配置

- 测试环境链接不到datanode1

- 分析

  > 1. 前一日由于194机器挂掉过导致k8s的dns跑到了别的机器上
  > 2. docker启动的时候默认是会把机器的dns配置同步进去的但是那台新的机器上之前的dns配置有问题不是指向的192.168.3.1 所以他同步进去的就不是对的
  > 3. 删除掉dns的pod让k8s自动重新部署一个就可以了
  >
  > > 如果docker run时不含`--dns=IP_ADDRESS..., --dns-search=DOMAIN..., or --dns-opt=OPTION...`参数，docker daemon会将copy本主机的/etc/resolv.conf，然后对该copy进行处理（将那些/etc/resolv.conf中ping不通的nameserver项给抛弃）,处理完成后留下的部分就作为该容器内部的/etc/resolv.conf。因此，如果你想利用宿主机中的/etc/resolv.conf配置的nameserver进行域名解析，那么你需要宿主机中该dns service配置一个宿主机内容器能ping通的IP。
  > >
  > > [docker container DNS配置介绍和源码分析](https://blog.csdn.net/waltonwang/article/details/54098592)